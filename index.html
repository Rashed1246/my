<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>المدونة الشخصية — لوحة تحكم</title>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#9aa4b2;
  --glass:rgba(255,255,255,0.03); --radius:12px; --font:'Segoe UI', Tahoma, system-ui, "Noto Naskh Arabic", sans-serif;
}
body{margin:0;min-height:100vh;background:var(--bg);color:#e6eef6;font-family:var(--font);-webkit-font-smoothing:antialiased}
body.light{background:linear-gradient(180deg,#fdfdfd,#f0f0f0);color:#111}
.app{display:grid;grid-template-columns:1fr 360px;gap:14px;min-height:100vh;padding:14px}
header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:var(--glass);flex-wrap:wrap}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;background:linear-gradient(90deg,var(--accent),#7c3aed);color:#fff}
.brand h1{font-size:16px;margin:0}
.brand p{margin:0;font-size:12px;color:var(--muted)}
.header-meta{display:flex;gap:12px;align-items:center;font-size:13px;color:var(--muted)}
main{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;overflow:auto}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
button{background:var(--card);border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer;min-width:110px}
button.primary{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#021022;font-weight:700}
.editor{min-height:50vh;padding:12px;background:#071526;border-radius:10px;border:1px solid rgba(255,255,255,0.02);font-size:16px;line-height:1.6;overflow:auto}
aside{background:linear-gradient(180deg,#071226,#071320);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:12px}
.card{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
label{font-size:13px;color:var(--muted)}
textarea,input[type="text"],select,input[type="password"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
textarea{min-height:60px;resize:vertical}
.switch{width:46px;height:26px;background:#0b1220;border-radius:999px;padding:3px;position:relative;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
.knob{width:18px;height:18px;background:white;border-radius:50%;position:absolute;left:3px;top:3px;transition:left .18s}
.switch.on{background:linear-gradient(90deg,#06b6d4,#7c3aed)}
.switch.on .knob{left:25px}
.meta{font-size:13px;color:var(--muted)}
.stat{display:flex;flex-direction:column;gap:6px}
#historyModal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
#historyModal .panel{width:min(920px,100%);max-height:80vh;background:var(--card);border-radius:10px;padding:12px;overflow:auto}
.history-item{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.history-actions{display:flex;gap:8px}
input[type="file"]{display:none}
.custom-file-upload{border:1px solid rgba(255,255,255,0.03);display:inline-block;padding:6px 12px;cursor:pointer;border-radius:10px;background:var(--card);color:var(--muted)}
.pw-overlay{position:fixed;inset:0;background:linear-gradient(135deg,#06b6d4,#7c3aed);display:flex;align-items:center;justify-content:center;z-index:100000;flex-direction:column;color:#fff}
.pw-box{background:rgba(0,0,0,0.06);padding:18px;border-radius:12px;min-width:280px;max-width:92%}
.bottom-bar{grid-column:1/-1;padding:12px;background:rgba(0,0,0,0.04);text-align:center;color:var(--muted);font-size:13px;border-radius:8px}
@media(max-width:880px){.app{grid-template-columns:1fr;padding:10px}.editor{min-height:40vh;font-size:15px}aside{order:2}}
</style>
</head>
<body>

<!-- شاشة كلمة المرور -->
<div id="pwScreen" class="pw-overlay">
  <div class="pw-box" role="dialog" aria-modal="true">
    <h2 style="margin:0 0 8px 0;text-align:center">أمان الدخول</h2>
    <div id="pwMessage" class="meta" style="margin-bottom:8px;text-align:center">أدخل كلمة المرور أو أنشئ كلمة مرور جديدة (محلياً).</div>
    <input id="pwInput" type="password" placeholder="أدخل كلمة المرور" />
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="pwConfirm" class="primary">تأكيد</button>
      <button id="pwSet">إنشاء/تغيير كلمة المرور</button>
    </div>
    <div style="margin-top:10px;text-align:center;font-size:12px;color:rgba(255,255,255,0.9)">كلمة المرور محفوظة فقط على جهازك (localStorage)</div>
  </div>
</div>

<!-- شاشة الترحيب -->
<div id="welcomeScreen" style="display:none;position:fixed;inset:0;background:linear-gradient(135deg,#06b6d4,#7c3aed);color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999">
  <h1 id="welcomeTitle" style="font-size:48px;margin:0">مرحباً بك في المدونة الشخصية</h1>
  <p id="welcomeCountdown" style="font-size:20px;margin-top:12px">سيتم فتح الموقع تلقائياً خلال 10 ثواني</p>
</div>

<!-- التطبيق -->
<div class="app" role="application" style="display:none">
  <header>
    <div class="brand">
      <div class="logo" id="logoTxt">م</div>
      <div>
        <h1 id="siteName">المدونة الشخصية</h1>
        <p id="siteTag">مذكرات وملاحظات محلية — تعمل بدون إنترنت</p>
      </div>
    </div>
    <div class="header-meta">
      <div id="clock">--:--:--</div>
      <div id="date">--/--/----</div>
    </div>
  </header>

  <main>
    <div class="controls" id="topControls">
      <button class="primary" id="saveBtn">حفظ</button>
      <button id="pdfBtn">تنزيل PDF</button>
      <button id="clearBtn">مسح المحتوى</button>
      <button id="newPageBtn">صفحة جديدة</button>
      <button id="historyBtn">المحفوظات</button>
      <label class="custom-file-upload" title="رفع صورة أو فيديو">
        <input type="file" id="fileUpload" accept="image/*,video/*" />
        رفع ملف
      </label>
      <button id="themeBtn">تبديل ليل/نهار</button>
      <button id="voiceBtn" class="primary">بدء الإملاء</button>
    </div>

    <div class="editor" id="editor" contenteditable="true" aria-label="محرر النص">
      اكتب هنا ملاحظاتك ومذكراتك... كل شيء محفوظ محلياً.
    </div>

    <div class="controls" style="margin-top:12px">
      <label style="min-width:120px">حجم الخط:
        <select id="fontSize" style="margin-left:8px">
          <option value="14px">14px</option>
          <option value="16px" selected>16px</option>
          <option value="18px">18px</option>
          <option value="20px">20px</option>
        </select>
      </label>
      <label style="min-width:180px">نوع الخط:
        <select id="fontFamily" style="margin-left:8px">
          <option value="Segoe UI, Tahoma, system-ui">Segoe UI</option>
          <option value="Tahoma, sans-serif">Tahoma</option>
          <option value="Noto Naskh Arabic, serif" selected>Noto Naskh Arabic</option>
          <option value="Cairo, sans-serif">Cairo</option>
        </select>
      </label>
    </div>
  </main>

  <aside>
    <div class="card">
      <label>اسم الموقع:</label>
      <input type="text" id="fixedSiteName" value="المدونة الشخصية" readonly />
      <small class="meta">اسم ثابت لا يمكن تغييره</small>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <label>حالة الموقع</label>
        <div id="switch" class="switch" role="switch" aria-checked="false"><div class="knob"></div></div>
      </div>
      <small id="statusInfo" class="meta">غير مفعل</small>
    </div>

    <div class="card">
      <button id="changePw" class="primary">تغيير كلمة المرور</button>
      <button id="logoutBtn">تسجيل الخروج</button>
    </div>

    <div class="card">
      <label>وصف الموقع:</label>
      <textarea id="siteDesc" readonly>
المدونة الشخصية: مساحة خاصة لكتابة الملاحظات والمذكرات وحفظها محليًا، رفع صور وفيديو، وإملاء صوتي. يمكن تنزيل المحتوى كـ PDF أو حفظ نسخ متعددة مع التاريخ والوقت.
      </textarea>
    </div>

    <div class="card stat">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <label>حجم النص المحفوظ</label><div class="value" id="len">0</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
        <label>آخر حفظ</label><div class="meta" id="lastSaved">لم يحفظ بعد</div>
      </div>
    </div>

  </aside>

  <div id="historyModal" aria-hidden="true">
    <div class="panel">
      <h3 style="margin:0 0 8px 0">المحفوظات <button id="closeHistory" style="float:left">إغلاق</button></h3>
      <div id="historyList"></div>
    </div>
  </div>

  <div class="toast" id="toast" style="display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#021526;color:#dff7fb;padding:10px 14px;border-radius:10px;z-index:99999">تم</div>

  <div class="bottom-bar">وصف ثابت: محرر ملاحظات محلي يعمل بدون إنترنت - احفظ، نزّل PDF، ارفع ملفات، واستخدم الإملاء الصوتي.</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded',()=>{

const PW_KEY='myapp:pw',CONTENT_KEY='myapp:content',SNAPSHOT_KEY='myapp:snapshots';
const pwScreen=document.getElementById('pwScreen'),pwInput=document.getElementById('pwInput'),pwConfirm=document.getElementById('pwConfirm'),pwSet=document.getElementById('pwSet'),pwMessage=document.getElementById('pwMessage');
const welcomeScreen=document.getElementById('welcomeScreen'),welcomeCountdown=document.getElementById('welcomeCountdown');
const appDiv=document.querySelector('.app'),editor=document.getElementById('editor'),saveBtn=document.getElementById('saveBtn'),pdfBtn=document.getElementById('pdfBtn'),clearBtn=document.getElementById('clearBtn'),newPageBtn=document.getElementById('newPageBtn'),historyBtn=document.getElementById('historyBtn'),fileUpload=document.getElementById('fileUpload'),themeBtn=document.getElementById('themeBtn'),voiceBtn=document.getElementById('voiceBtn'),fontSize=document.getElementById('fontSize'),fontFamily=document.getElementById('fontFamily'),lenEl=document.getElementById('len'),lastSaved=document.getElementById('lastSaved'),historyModal=document.getElementById('historyModal'),historyList=document.getElementById('historyList'),closeHistory=document.getElementById('closeHistory'),switchEl=document.getElementById('switch'),statusInfo=document.getElementById('statusInfo'),changePwBtn=document.getElementById('changePw'),logoutBtn=document.getElementById('logoutBtn'),toast=document.getElementById('toast');

function showToast(msg,ms=2000){toast.textContent=msg;toast.style.display='block';setTimeout(()=>toast.style.display='none',ms);}
function hasPassword(){return !!localStorage.getItem(PW_KEY);}
function checkPassword(pw){return localStorage.getItem(PW_KEY)===pw;}
function setPassword(pw){if(!pw)return false;localStorage.setItem(PW_KEY,pw);return true;}
pwScreen.style.display='flex';appDiv.style.display='none';welcomeScreen.style.display='none';pwMessage.textContent=hasPassword()?'أدخل كلمة المرور':'أنشئ كلمة مرور جديدة';

pwConfirm.addEventListener('click',()=>{
  const val=pwInput.value.trim();
  if(!val){showToast('أدخل كلمة المرور');return;}
  if(!hasPassword()){showToast('أنشئ كلمة مرور أولاً');return;}
  if(checkPassword(val)){pwScreen.style.display='none';startWelcomeAndOpenApp();}
  else showToast('كلمة المرور غير صحيحة');
});

pwSet.addEventListener('click',()=>{
  if(hasPassword()){
    const cur=prompt('أدخل كلمة المرور الحالية:');
    if(!checkPassword(cur)){alert('كلمة المرور خاطئة');return;}
  }
  const np=prompt('أدخل كلمة المرور الجديدة (3 أحرف على الأقل):');
  if(np && np.length>=3){setPassword(np);showToast('تم حفظ كلمة المرور محلياً');}
  else{alert('كلمة المرور قصيرة');}
});

function startWelcomeAndOpenApp(){
  welcomeScreen.style.display='flex';appDiv.style.display='none';
  let sec=10;const timer=setInterval(()=>{
    sec--;welcomeCountdown.textContent=`سيتم فتح الموقع تلقائياً خلال ${sec} ثواني`;
    if(sec<=0){clearInterval(timer);welcomeScreen.style.display='none';appDiv.style.display='grid';initApp();}
  },1000);
}

let recognition=null,isRecording=false;
function initApp(){
  const saved=localStorage.getItem(CONTENT_KEY);if(saved)editor.innerHTML=saved;
  lenEl.textContent=editor.innerText.length;
  lastSaved.textContent=localStorage.getItem('lastSaved')||'لم يحفظ بعد';

  function updateClock(){const d=new Date();document.getElementById('clock').textContent=d.toLocaleTimeString();document.getElementById('date').textContent=d.toLocaleDateString();}
  updateClock();setInterval(updateClock,1000);

  editor.addEventListener('input',()=>{
    localStorage.setItem(CONTENT_KEY,editor.innerHTML);
    lenEl.textContent=editor.innerText.length;
    localStorage.setItem('lastSaved',new Date().toLocaleString());
    lastSaved.textContent=localStorage.getItem('lastSaved');
  });

  saveBtn.addEventListener('click',saveNow);
  pdfBtn.addEventListener('click',downloadPDF);
  clearBtn.addEventListener('click',()=>{if(confirm('مسح المحتوى؟')){editor.innerHTML='';localStorage.removeItem(CONTENT_KEY);showToast('تم المسح');}});
  newPageBtn.addEventListener('click',()=>{if(confirm('صفحة جديدة؟')){editor.innerHTML='';showToast('صفحة جديدة');}});
  themeBtn.addEventListener('click',()=>{document.body.classList.toggle('light');});
  fileUpload.addEventListener('change',handleFileUpload);
  historyBtn.addEventListener('click',openHistory);
  closeHistory
  .addEventListener('click',()=>{historyModal.style.display='none';});
switchEl.addEventListener('click',toggleStatus);
setupRecognition();
voiceBtn.addEventListener('click',toggleRecording);
changePwBtn.addEventListener('click',changePassword);
logoutBtn.addEventListener('click',logout);
fontSize.addEventListener('change',()=>{editor.style.fontSize=fontSize.value;});
fontFamily.addEventListener('change',()=>{editor.style.fontFamily=fontFamily.value;});
}

/* ---------- حفظ المحتوى ---------- */
function saveNow(){
  const html=editor.innerHTML;
  localStorage.setItem(CONTENT_KEY,html);
  let snaps=JSON.parse(localStorage.getItem(SNAPSHOT_KEY)||'[]');
  const ts=new Date().toLocaleString();
  snaps.unshift({html,ts});
  if(snaps.length>50) snaps=snaps.slice(0,50);
  localStorage.setItem(SNAPSHOT_KEY,JSON.stringify(snaps));
  localStorage.setItem('lastSaved',ts);
  lastSaved.textContent=ts;
  lenEl.textContent=editor.innerText.length;
  showToast('تم الحفظ محلياً');
}

/* ---------- رفع الملفات ---------- */
function handleFileUpload(e){
  const file=e.target.files[0];if(!file)return;
  if(file.size>2*1024*1024){alert('الملف كبير جداً (أقصى حجم 2 ميجابايت)');return;}
  const r=new FileReader();
  r.onload=ev=>{
    if(file.type.startsWith('image/')){
      const img=document.createElement('img');img.src=ev.target.result;img.style.maxWidth='100%';editor.appendChild(img);
    } else if(file.type.startsWith('video/')){
      const v=document.createElement('video');v.src=ev.target.result;v.controls=true;v.style.maxWidth='100%';editor.appendChild(v);
    }
    localStorage.setItem(CONTENT_KEY,editor.innerHTML);
  };
  r.readAsDataURL(file);
  e.target.value='';
}

/* ---------- عرض المحفوظات ---------- */
function openHistory(){
  const snaps=JSON.parse(localStorage.getItem(SNAPSHOT_KEY)||'[]');
  historyList.innerHTML='';
  if(!snaps.length){historyList.innerHTML='<div class="meta">لا توجد نسخ محفوظة</div>';return;}
  snaps.forEach((s,idx)=>{
    const d=document.createElement('div');d.className='history-item';
    const txt=document.createElement('div');txt.textContent=s.ts;
    const b1=document.createElement('button');b1.textContent='تحميل';
    const b2=document.createElement('button');b2.textContent='حذف';
    b1.onclick=()=>{editor.innerHTML=s.html;localStorage.setItem(CONTENT_KEY,s.html);showToast('تم التحميل');historyModal.style.display='none';};
    b2.onclick=()=>{let a=JSON.parse(localStorage.getItem(SNAPSHOT_KEY)||'[]');a.splice(idx,1);localStorage.setItem(SNAPSHOT_KEY,JSON.stringify(a));openHistory();};
    const act=document.createElement('div');act.className='history-actions';act.append(b1,b2);
    d.append(txt,act);historyList.append(d);
  });
  historyModal.style.display='flex';
}

/* ---------- تبديل حالة الموقع ---------- */
function toggleStatus(){
  switchEl.classList.toggle('on');
  const on=switchEl.classList.contains('on');
  statusInfo.textContent=on?'مفعل':'غير مفعل';
}

/* ---------- الإملاء الصوتي ---------- */
function setupRecognition(){
  window.SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition||null;
  if(!window.SpeechRecognition){recognition=null;voiceBtn.textContent='غير مدعوم';return;}
  recognition=new SpeechRecognition();
  recognition.lang='ar-SA';recognition.interimResults=false;recognition.continuous=true;
  recognition.onresult=e=>{
    const t=e.results[e.results.length-1][0].transcript;
    editor.innerHTML+=` ${t}`;
    localStorage.setItem(CONTENT_KEY,editor.innerHTML);
    lenEl.textContent=editor.innerText.length;
  };
  recognition.onend=()=>{if(isRecording){try{recognition.start();}catch(e){isRecording=false;voiceBtn.textContent='بدء الإملاء';}}else{voiceBtn.textContent='بدء الإملاء';}};
}
function toggleRecording(){
  if(!recognition){showToast('غير مدعوم');return;}
  if(!isRecording){try{recognition.start();isRecording=true;voiceBtn.textContent='إيقاف الإملاء';}catch(e){console.warn(e);}}
  else{isRecording=false;recognition.stop();}
}

/* ---------- تغيير كلمة المرور ---------- */
function changePassword(){
  const cur=prompt('أدخل كلمة المرور الحالية:');
  if(!checkPassword(cur)){alert('كلمة المرور خاطئة');return;}
  const np=prompt('أدخل كلمة المرور الجديدة (3 أحرف على الأقل):');
  if(np && np.length>=3){setPassword(np);showToast('تم تغيير كلمة المرور');}
  else{alert('كلمة المرور قصيرة');}
}

/* ---------- تسجيل الخروج ---------- */
function logout(){if(confirm('تسجيل خروج؟')){appDiv.style.display='none';pwScreen.style.display='flex';}}

/* ---------- تنزيل PDF ---------- */
function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait',unit:'pt',format:'a4'});
  doc.setFont("NotoNaskhArabic");
  const content=editor.innerText;
  const lines=doc.splitTextToSize(content,500);
  doc.text(lines,40,40);
  doc.save('مدونتي.pdf');
}

});
</script>
</body>
        </html> 
