<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>المدونة الشخصية — لوحة تحكم</title>

<!-- CDN libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#9aa4b2;
    --glass:rgba(255,255,255,0.03); --radius:12px; --transition:180ms;
    --font: 'Segoe UI', Tahoma, system-ui, "Noto Naskh Arabic", sans-serif;
  }
  body.light{
    --bg:#f5f7fa; --card:#fff; --accent:#ef4444; --muted:#444;
    --glass:rgba(0,0,0,0.06); color:#111;
    background:linear-gradient(180deg,#fdfdfd,#f0f0f0);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;font-family:var(--font)}
  /* layout */
  .app{display:grid;grid-template-columns:1fr 320px;gap:14px;min-height:100vh;padding:14px}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--glass);border-radius:12px;flex-wrap:wrap}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;background:linear-gradient(90deg,var(--accent),#7c3aed)}
  .brand h1{font-size:16px;margin:0}
  .brand p{margin:0;font-size:12px;color:var(--muted)}
  main{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;overflow:auto}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  button{background:var(--card);border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer;transition:all var(--transition);min-width:110px;text-align:center}
  button.primary{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#021022;font-weight:700}
  .editor{min-height:48vh;padding:12px;background:#071526;border-radius:10px;border:1px solid rgba(255,255,255,0.02);font-size:16px;line-height:1.6;overflow:auto}
  aside{background:linear-gradient(180deg,#071226,#071320);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:12px;align-items:stretch;overflow:auto}
  .card{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
  label{font-size:13px;color:var(--muted)}
  input[type=text], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
  textarea{min-height:70px;resize:vertical}
  .stat{display:flex;flex-direction:column;gap:6px}
  .stat .value{font-size:18px;color:#e6f8fb;font-weight:700}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#021526;color:#dff7fb;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(2,6,23,0.6);display:none;z-index:9999}
  #historyModal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
  #historyModal .panel{width:min(920px,100%);max-height:80vh;background:var(--card);border-radius:10px;padding:12px;overflow:auto}
  .history-item{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;display:flex;justify-content:space-between;gap:8px;align-items:center}
  .header-meta{display:flex;gap:12px;align-items:center;font-size:13px;color:var(--muted)}
  .pw-overlay{position:fixed;inset:0;background:linear-gradient(135deg,#06b6d4,#7c3aed);display:flex;align-items:center;justify-content:center;z-index:100000;flex-direction:column;color:#fff;padding:18px}
  .pw-box{background:rgba(255,255,255,0.06);padding:14px;border-radius:12px;width:100%;max-width:420px}
  .small-muted{font-size:12px;color:rgba(255,255,255,0.8);margin-top:6px}
  .bottom-bar{grid-column:1/-1;background:var(--card);padding:10px;border-radius:10px;text-align:center;color:var(--muted);font-size:13px}
  input[type=file]{display:none}
  .custom-file-upload{border:1px solid rgba(255,255,255,0.03);display:inline-block;padding:6px 12px;cursor:pointer;border-radius:10px;background:var(--card);color:var(--muted)}
  @media(max-width:880px){
    .app{grid-template-columns:1fr;padding:10px}
    aside{order:2;max-height:300px}
    main{order:1}
    .controls button{flex:1 1 45%}
    .editor{min-height:40vh;font-size:15px}
    header{justify-content:center}
  }
</style>
</head>
<body>

<!-- شاشة كلمة المرور (تظهر قبل الترحيب) -->
<div id="pwScreen" class="pw-overlay" style="display:flex;">
  <div class="pw-box">
    <h2 style="margin:0 0 8px 0;text-align:center">أدخل كلمة المرور للولوج</h2>
    <input id="pwInput" type="text" placeholder="اكتب كلمة مرور جديدة أو أدخل الموجودة" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="pwConfirm" class="primary">تأكيد / دخول</button>
      <button id="pwSet">إنشاء/تغيير كلمة مرور</button>
    </div>
    <div class="small-muted">إذا لم تكن قد أنشأت كلمة مرور من قبل: اكتب كلمة جديدة واضغط "إنشاء/تغيير".</div>
  </div>
  <div style="margin-top:12px;color:rgba(255,255,255,0.95)">شاشة الترحيب تظهر بعد الدخول</div>
</div>

<!-- شاشة الترحيب -->
<div id="welcomeScreen" style="display:none;position:fixed;inset:0;background:linear-gradient(135deg,#06b6d4,#7c3aed);color:#fff;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:99999;padding:18px">
  <h1 id="welcomeTitle" style="font-size:48px;margin:0">مرحباً بك في المدونة الشخصية</h1>
  <p id="welcomeCount" style="margin-top:12px;font-size:18px">سيتم فتح الموقع تلقائياً خلال 10 ثواني</p>
</div>

<!-- التطبيق -->
<div class="app" role="application" style="display:none;">
  <header>
    <div class="brand">
      <div class="logo" id="logoTxt">م</div>
      <div>
        <h1 id="siteName">المدونة الشخصية</h1>
        <p id="siteTag">مذكرة شخصية بسيطة — احفظ، نزّل، شارك</p>
      </div>
    </div>
    <div class="header-meta">
      <div id="clock">--:--:--</div>
      <div id="date">--/--/----</div>
    </div>
  </header>

  <main>
    <!-- صف الأزرار العلوي (اثنان في السطر الأول، والباقي أسفله حسب طلبك) -->
    <div class="controls" id="row1" style="flex-wrap:wrap">
      <button class="primary" id="saveBtn">حفظ</button>
      <button id="downloadPdfBtn">تنزيل PDF</button>
    </div>

    <div class="controls" id="row2">
      <button id="clearBtn">مسح المحتوى</button>
      <button id="timeBtn">الساعة (حيّة)</button>
      <button id="themeBtn">تبديل ليل/نهار</button>
      <button id="newPageBtn">صفحة جديدة</button>
      <button id="historyBtn">المحفوظات</button>
      <label class="custom-file-upload">
        <input id="fileUpload" type="file" accept="image/*,video/*" />
        رفع ملف
      </label>
      <button id="voiceBtn" class="primary">بدء الإملاء</button>
      <button id="downloadDocBtn">تنزيل Word</button>
    </div>

    <!-- المحرر -->
    <div id="editor" class="editor" contenteditable="true" aria-label="محرر النص">
      اكتب ملاحظاتك هنا... يدعم رفع الصور والفيديو، حفظ متعدد، وتنزيل PDF/Word.
    </div>

    <!-- تحكمات الخط -->
    <div class="controls" style="margin-top:12px">
      <label>حجم الخط:
        <select id="fontSize" style="margin-left:8px">
          <option value="14px">14px</option>
          <option value="16px" selected>16px</option>
          <option value="18px">18px</option>
          <option value="20px">20px</option>
        </select>
      </label>
      <label>نوع الخط:
        <select id="fontFamily" style="margin-left:8px">
          <option value="'Segoe UI',Tahoma,system-ui">Segoe UI</option>
          <option value="'Tahoma',sans-serif">Tahoma</option>
          <option value="'Noto Naskh Arabic',serif" selected>Noto Naskh Arabic</option>
          <option value="'Cairo',sans-serif">Cairo</option>
        </select>
      </label>
    </div>
  </main>

  <!-- الشريط الجانبي -->
  <aside>
    <div class="card">
      <label>اسم الموقع (ثابت)</label>
      <input id="siteInput" type="text" value="المدونة الشخصية" readonly />
      <small class="small-muted">اسم الموقع ثابت كما طلبت.</small>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <label>حالة الموقع</label>
        <div id="switch" class="switch" role="switch" aria-checked="false" style="width:46px;height:26px;background:#0b1220;border-radius:999px;padding:3px;position:relative;cursor:pointer;border:1px solid rgba(255,255,255,0.02)">
          <div class="knob" style="width:18px;height:18px;background:white;border-radius:50%;position:absolute;left:3px;top:3px;transition:left var(--transition)"></div>
        </div>
      </div>
      <small id="statusInfo" class="small-muted">الحالة: غير مفعل</small>
    </div>

    <div class="card">
      <label>وصف الموقع (ثابت)</label>
      <textarea id="siteDesc" readonly>
هذه مدونتي الشخصية (مذكرة محلية). يمكنك كتابة الملاحظات، رفع صور/فيديو، حفظ عدة نسخ بتاريخ ووقت، وتنزيل المحتوى كـ PDF أو Word. المحفوظات تعمل محلياً بدون إنترنت.
      </textarea>
    </div>

    <div class="card stat">
      <div class="row"><label>حجم النص الحالي</label><div class="value" id="len">0</div></div>
      <div class="row"><label>آخر حفظ</label><div class="meta" id="lastSaved">لم يحفظ بعد</div></div>
      <div style="margin-top:8px"><button id="settingsBtn">الإعدادات (تغيير كلمة المرور / تسجيل خروج)</button></div>
    </div>
  </aside>

  <!-- مودال المحفوظات -->
  <div id="historyModal" aria-hidden="true">
    <div class="panel">
      <h3 style="margin:0 0 8px 0">المحفوظات <button id="closeHistory" style="float:left">إغلاق</button></h3>
      <div id="historyList"></div>
    </div>
  </div>

  <div class="toast" id="toast">تم</div>

  <div class="bottom-bar">وصف ثابت وواضح: مدونة شخصية تعمل محلياً — احفظ ملاحظاتك، ارفع صور/فيديو، أنشئ PDF أو Word وشاركها.</div>
</div>

<!-- إعدادات كلمة المرور مودال بسيط (سيظهر على وضعية التطبيق) -->
<div id="settingsModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:100000;padding:18px">
  <div style="background:var(--card);padding:14px;border-radius:12px;max-width:420px;color:var(--muted)">
    <h3 style="color:#fff;margin-top:0">الإعدادات</h3>
    <div style="margin-bottom:8px">
      <label>تغيير كلمة المرور (أدخل القديمة ثم الجديدة)</label>
      <input id="oldPw" type="text" placeholder="كلمة المرور القديمة" />
      <input id="newPw" type="text" placeholder="الكلمة الجديدة" style="margin-top:8px" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="changePwBtn" class="primary">تغيير</button>
        <button id="logoutBtn">خروج</button>
      </div>
    </div>
    <div style="margin-top:6px"><button id="closeSettings">إغلاق</button></div>
  </div>
</div>

<script>
/* ========== CONSTANTS & HELPERS ========== */
const TOAST = document.getElementById('toast');
const showToast = (msg, ms=1800)=>{TOAST.textContent=msg;TOAST.style.display='block';setTimeout(()=>TOAST.style.display='none',ms)}

/* simple SHA-256 using SubtleCrypto: returns hex */
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* IndexedDB wrapper (promisified) */
const DB_NAME='my_blog_db', DB_VERSION=1, STORE_POSTS='posts';
function openDB(){
  return new Promise((res, rej)=>{
    const r = indexedDB.open(DB_NAME, DB_VERSION);
    r.onupgradeneeded = ()=> {
      const db = r.result;
      if (!db.objectStoreNames.contains(STORE_POSTS)) {
        db.createObjectStore(STORE_POSTS, { keyPath: 'id' });
      }
    };
    r.onsuccess = ()=> res(r.result);
    r.onerror = ()=> rej(r.error);
  });
}
async function dbPutPost(post){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE_POSTS,'readwrite');
    const store = tx.objectStore(STORE_POSTS);
    store.put(post);
    tx.oncomplete = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}
async function dbGetAll(){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE_POSTS,'readonly');
    const store = tx.objectStore(STORE_POSTS);
    const req = store.getAll();
    req.onsuccess = ()=> res(req.result);
    req.onerror = ()=> rej(req.error);
  });
}
async function dbDelete(id){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE_POSTS,'readwrite');
    tx.objectStore(STORE_POSTS).delete(id);
    tx.oncomplete = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}

/* ========== ELEMENTS ========== */
const pwScreen = document.getElementById('pwScreen');
const pwInput = document.getElementById('pwInput');
const pwConfirm = document.getElementById('pwConfirm');
const pwSet = document.getElementById('pwSet');

const welcomeScreen = document.getElementById('welcomeScreen');
const welcomeCount = document.getElementById('welcomeCount');
const app = document.querySelector('.app');

const editor = document.getElementById('editor');
const saveBtn = document.getElementById('saveBtn');
const downloadPdfBtn = document.getElementById('downloadPdfBtn');
const downloadDocBtn = document.getElementById('downloadDocBtn');
const clearBtn = document.getElementById('clearBtn');
const timeBtn = document.getElementById('timeBtn');
const themeBtn = document.getElementById('themeBtn');
const newPageBtn = document.getElementById('newPageBtn');
const historyBtn = document.getElementById('historyBtn');
const fileUpload = document.getElementById('fileUpload');
const voiceBtn = document.getElementById('voiceBtn');
const fontSize = document.getElementById('fontSize');
const fontFamily = document.getElementById('fontFamily');
const lenEl = document.getElementById('len');
const lastSaved = document.getElementById('lastSaved');
const historyModal = document.getElementById('historyModal');
const historyList = document.getElementById('historyList');
const closeHistory = document.getElementById('closeHistory');

const switchEl = document.getElementById('switch');
const statusInfo = document.getElementById('statusInfo');
const settingsBtn = document.getElementById('settingsBtn');

const settingsModal = document.getElementById('settingsModal');
const closeSettings = document.getElementById('closeSettings');
const changePwBtn = document.getElementById('changePwBtn');
const logoutBtn = document.getElementById('logoutBtn');
const oldPw = document.getElementById('oldPw');
const newPw = document.getElementById('newPw');

/* keys */
const PW_KEY = 'my_blog_pw_hash';
const CURRENT_SESSION = 'my_blog_session_ok';

/* ========== PASSWORD FLOW ========== */
async function checkPassword(plain){
  const stored = localStorage.getItem(PW_KEY);
  if(!stored) return false;
  const h = await sha256Hex(plain);
  return h === stored;
}
async function setPassword(plain){
  const h = await sha256Hex(plain);
  localStorage.setItem(PW_KEY, h);
  return true;
}
function openAppAfterLogin(){
  pwScreen.style.display='none';
  // show welcome 10s
  welcomeScreen.style.display='flex';
  let cnt=10;
  welcomeCount.textContent = `سيتم فتح الموقع تلقائياً خلال ${cnt} ثواني`;
  const iv = setInterval(()=>{
    cnt--; welcomeCount.textContent = `سيتم فتح الموقع تلقائياً خلال ${cnt} ثواني`;
    if(cnt<=0){ clearInterval(iv); welcomeScreen.style.display='none'; app.style.display='grid'; startClock(); loadInitialData(); }
  },1000);
}

/* event: confirm (login) */
pwConfirm.addEventListener('click', async ()=>{
  const val = pwInput.value.trim();
  if(!val){ showToast('اكتب كلمة المرور'); return; }
  const ok = await checkPassword(val);
  if(!ok){ showToast('كلمة المرور خاطئة'); return; }
  localStorage.setItem(CURRENT_SESSION, '1');
  openAppAfterLogin();
});

/* event: set/create password */
pwSet.addEventListener('click', async ()=>{
  const val = pwInput.value.trim();
  if(!val){ showToast('اكتب كلمة جديدة لإنشاءها'); return; }
  // إذا كانت هنالك كلمة سابقة — اطلب تأكيد؟ هنا نبدّل مباشرة (بناء على طلبك يسمح بالتغيير عند إدخال جديدة)
  await setPassword(val);
  localStorage.setItem(CURRENT_SESSION, '1');
  showToast('تم إنشاء/تغيير كلمة المرور');
  openAppAfterLogin();
});

/* إذا السيرفر محفوظ أنه دخل سابقاً (session) وPW موجود نعرض ال pwScreen لنطلبها دائماً حسب طلبك
   لكن أنت قلت: "يجب أن يطلب كلمة المرور كل مرة يدخل المستخدم" -> لذلك لا نستخدم جلسة دائمة.
   هنا: لنحترم طلبك: كل فتح صفحة يطلب كلمة المرور. لذلك CURRENT_SESSION لن يُستخدم persistently.
*/

/* ========== CLOCK ========== */
function startClock(){
  const clock = document.getElementById('clock');
  const dateBox = document.getElementById('date');
  function update(){
    const d = new Date();
    clock.textContent = d.toLocaleTimeString();
    dateBox.textContent = d.toLocaleDateString();
  }
  update(); setInterval(update,1000);
}

/* ========== EDITOR & SAVE ========== */
function updateLen(){ lenEl.textContent = editor.innerText.trim().length }
editor.addEventListener('input', ()=>{
  updateLen();
});

/* Save current content as a new post with timestamp OR update an active post id (simpler: always save snapshot) */
async function saveNow(){
  const id = 'post-' + Date.now();
  const html = editor.innerHTML;
  const post = { id, html, createdAt: new Date().toISOString() };
  await dbPutPost(post);
  localStorage.setItem('lastSaved', new Date().toLocaleString());
  lastSaved.textContent = localStorage.getItem('lastSaved');
  updateLen();
  showToast('تم الحفظ');
}

/* attach to save button */
saveBtn.addEventListener('click', saveNow);

/* New page (clear editor) */
newPageBtn.addEventListener('click', ()=>{
  if(!confirm('إنشاء صفحة جديدة؟ سيفقد المحتوى الحالي')) return;
  editor.innerHTML = '';
  updateLen();
  showToast('صفحة جديدة');
});

/* Clear */
clearBtn.addEventListener('click', ()=>{
  if(confirm('حذف المحتوى الحالي؟')){ editor.innerHTML=''; updateLen(); showToast('تم المسح') }
});

/* font controls */
fontSize.addEventListener('change', ()=>editor.style.fontSize = fontSize.value);
fontFamily.addEventListener('change', ()=>editor.style.fontFamily = fontFamily.value);

/* ========== HISTORY (المحفوظات) ========== */
historyBtn.addEventListener('click', async ()=>{
  historyList.innerHTML = '';
  const items = await dbGetAll();
  // sort by newest
  items.sort((a,b)=> (a.createdAt < b.createdAt) ? 1 : -1);
  items.forEach((it, idx)=>{
    const div = document.createElement('div'); div.className = 'history-item';
    const meta = document.createElement('div'); meta.className='meta';
    const dt = new Date(it.createdAt).toLocaleString();
    meta.textContent = `${dt} — ${stripText(it.html).substring(0,120)}...`;
    const actions = document.createElement('div'); actions.className='history-actions';
    const loadBtn = document.createElement('button'); loadBtn.textContent='عرض';
    loadBtn.onclick = ()=>{ editor.innerHTML = it.html; updateLen(); showToast('تم تحميل النسخة'); historyModal.style.display='none'; }
    const delBtn = document.createElement('button'); delBtn.textContent='حذف';
    delBtn.onclick = async ()=>{ await dbDelete(it.id); div.remove(); showToast('تم الحذف'); };
    actions.appendChild(loadBtn); actions.appendChild(delBtn);
    div.appendChild(meta); div.appendChild(actions);
    historyList.appendChild(div);
  });
  historyModal.style.display='flex';
});
closeHistory.addEventListener('click', ()=>historyModal.style.display='none');

function stripText(html){ const tmp = document.createElement('div'); tmp.innerHTML=html; return tmp.textContent || tmp.innerText || ''; }

/* ========== FILE UPLOAD (image/video) ========== */
fileUpload.addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    if(file.type.startsWith('image')){
      const img = document.createElement('img'); img.src = ev.target.result; img.style.maxWidth='100%';
      editor.appendChild(img);
    } else if(file.type.startsWith('video')){
      const vid = document.createElement('video'); vid.src = ev.target.result; vid.controls=true; vid.style.maxWidth='100%';
      editor.appendChild(vid);
    }
    updateLen();
    showToast('تم رفع الملف (محلياً)');
  };
  reader.readAsDataURL(file);
});

/* ========== SPEECH RECOGNITION (toggle start/stop) ========== */
let recognition=null, isRecording=false;
function setupRecognition(){
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){
    voiceBtn.disabled=true; voiceBtn.textContent='الإملاء غير مدعوم';
    return;
  }
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new Rec();
  recognition.lang = 'ar-SA';
  recognition.interimResults = false;
  recognition.continuous = true;
  recognition.onresult = (e)=>{
    let text='';
    for(let i=e.resultIndex;i<e.results.length;i++){ text += e.results[i][0].transcript; }
    editor.innerHTML += ' ' + text;
    editor.scrollTop = editor.scrollHeight;
    updateLen();
    showToast('نص مضاف من الإملاء');
  };
  recognition.onerror = (err)=>{ console.warn('recognition error', err); showToast('خطأ في الإملاء'); };
  recognition.onend = ()=>{ isRecording=false; voiceBtn.textContent='بدء الإملاء'; showToast('تم إيقاف الإملاء'); };
}
setupRecognition();
voiceBtn.addEventListener('click', ()=>{
  if(!recognition) return;
  if(!isRecording){
    try{ recognition.start(); isRecording=true; voiceBtn.textContent='إيقاف الإملاء'; showToast('بدء الإملاء'); }
    catch(e){ console.warn(e); showToast('تعذر بدء الإملاء'); }
  } else { recognition.stop(); /* onend handler will run */ }
});

/* ========== DOWNLOAD PDF & WORD ========== */
downloadPdfBtn.addEventListener('click', async ()=>{
  showToast('جاري إنشاء PDF...');
  const { jsPDF } = window.jspdf;
  // Use html2canvas to create image(s) then push to jsPDF
  const node = document.createElement('div');
  node.style.padding = '20px';
  node.style.background = '#fff';
  node.innerHTML = `<h2>${document.getElementById('siteName').textContent}</h2>` + editor.innerHTML;
  // Render to canvas
  const canvas = await html2canvas(node, { scale: 2, useCORS:true });
  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF('p','mm','a4');
  const imgProps = pdf.getImageProperties(imgData);
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
  pdf.save('post.pdf');
  showToast('تم تنزيل PDF');
});

downloadDocBtn.addEventListener('click', ()=>{
  // create a .doc by using HTML content in a blob of type msword (widely accepted)
  const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Document</title></head><body>`;
  const footer = '</body></html>';
  const html = header + `<h2>${document.getElementById('siteName').textContent}</h2>` + editor.innerHTML + footer;
  const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'post.doc';
  a.click(); URL.revokeObjectURL(url);
  showToast('تم تنزيل Word');
});

/* ========== THEME & STATUS SWITCH ========== */
themeBtn.addEventListener('click', ()=> document.body.classList.toggle('light'));
switchEl.addEventListener('click', ()=> {
  switchEl.classList.toggle('on');
  const on = switchEl.classList.contains('on');
  const knob = switchEl.querySelector('.knob');
  if(on) { knob.style.left='25px'; statusInfo.textContent='الحالة: مفعل'; } else { knob.style.left='3px'; statusInfo.textContent='الحالة: غير مفعل'; }
});

/* ========== SETTINGS (change password & logout) ========== */
settingsBtn.addEventListener('click', ()=> settingsModal.style.display='flex');
closeSettings.addEventListener('click', ()=> settingsModal.style.display='none');

changePwBtn.addEventListener('click', async ()=>{
  const oldVal = oldPw.value.trim(); const newVal = newPw.value.trim();
  if(!oldVal || !newVal){ showToast('املأ القديم والجديد'); return; }
  const ok = await checkPassword(oldVal);
  if(!ok){ showToast('كلمة المرور القديمة خاطئة'); return; }
  await setPassword(newVal);
  showToast('تم تغيير كلمة المرور');
  oldPw.value=''; newPw.value='';
  settingsModal.style.display='none';
});

logoutBtn.addEventListener('click', async ()=>{
  const pw = prompt('أدخل كلمة المرور لتأكيد الخروج:');
  if(!pw) return;
  const ok = await checkPassword(pw);
  if(!ok){ alert('كلمة المرور خاطئة'); return; }
  // نعيد لواجهة كلمة المرور
  app.style.display='none';
  pwScreen.style.display='flex';
  showToast('تم تسجيل الخروج');
});

/* ========== INITIAL LOAD & helper ========== */
async function loadInitialData(){
  // load last saved
  const list = await dbGetAll();
  // if content exists in DB, load most recent; else keep editor default
  if(list.length>0){
    list.sort((a,b)=> a.createdAt < b.createdAt ? 1 : -1);
    editor.innerHTML = list[0].html;
    lastSaved.textContent = new Date(list[0].createdAt).toLocaleString();
  } else {
    // if there's fallback content in localStorage content key, load it
    const fallback = localStorage.getItem('content');
    if(fallback) editor.innerHTML = fallback;
  }
  updateLen();
}

/* If no password set at all, we let user create one first time.
   Show pwScreen always (user asked to require password every time).
*/
(function initOnLoad(){
  // show pwScreen (it is already visible by default)
  // note: if no PW set, user must create one via "إنشاء/تغيير"
  // If a pw exists and user enters it, they get in.
  // No persistent session across reload (requested).
})();

/* ========== Offline Service Worker registration (optional) ========== */
if('serviceWorker' in navigator){
  try{
    navigator.serviceWorker.register('sw.js').then(()=> console.log('sw registered')).catch(()=>{/*ignore*/});
  }catch(e){}
}

/* small utility: if user presses Enter in pwInput trigger confirm */
pwInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') pwConfirm.click(); });

</script>

</body>
</html>
